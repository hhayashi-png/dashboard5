<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚¨ã‚¹ãƒ†äº‹æ¥­éƒ¨ é€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  /* White Clean Theme */
  --bg: #FFFFFF;           /* å…¨ä½“èƒŒæ™¯ */
  --card: #FFFFFF;         /* ã‚«ãƒ¼ãƒ‰ */
  --card-hover: #FFF7FB;   /* hover */
  --border: #E9E9EF;       /* æ ç·š */
  --text: #1A1A1A;         /* ãƒ¡ã‚¤ãƒ³æ–‡å­— */
  --text-sub: #7A7A85;     /* ã‚µãƒ–æ–‡å­— */

  --accent: #E64B8B;       /* ä¸Šå“ãƒ”ãƒ³ã‚¯ */
  --accent-light: #FF7AB6;

  --success: #00B894;
  --warning: #F4B740;
  --danger: #E44D61;

  --blue: #6AA7FF;
  --pink: #E64B8B;
  --orange: #E58A5B;
  --teal: #00B894;
}

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', 'Noto Sans JP', sans-serif;
    min-height: 100vh;
  }

  /* â”€â”€ Header â”€â”€ */
  .header {
    background: linear-gradient(135deg, var(--card) 0%, var(--bg) 100%);
    border-bottom: 1px solid var(--border);
    padding: 24px 32px 0;
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(20px);
  }
  .header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
  .header-title { display: flex; align-items: center; gap: 12px; }
  .header-icon {
    width: 40px; height: 40px; border-radius: 12px;
    background: linear-gradient(135deg, var(--accent), var(--success));
    display: flex; align-items: center; justify-content: center; font-size: 20px;
  }
  .header h1 { font-size: 22px; font-weight: 800; }
  .header-sub { font-size: 12px; color: var(--text-sub); margin-top: 2px; }
  .live-badge {
    padding: 6px 14px; border-radius: 20px;
    background: rgba(0,206,201,0.13); border: 1px solid rgba(0,206,201,0.27);
    font-size: 12px; color: var(--success); font-weight: 600;
  }
  .refresh-btn {
    padding: 6px 14px; border-radius: 20px; border: 1px solid var(--border);
    background: var(--card); color: var(--text-sub); font-size: 12px;
    cursor: pointer; font-weight: 600; margin-left: 8px; transition: all 0.2s;
  }
  .refresh-btn:hover { background: var(--card-hover); color: var(--text); border-color: var(--accent); }
  .refresh-btn.loading { opacity: 0.5; pointer-events: none; }

  /* â”€â”€ Tabs â”€â”€ */
  .tabs { display: flex; gap: 4px; }
  .tab {
    padding: 10px 20px; border-radius: 10px 10px 0 0; border: none;
    background: transparent; color: var(--text-sub); font-size: 13px;
    font-weight: 500; cursor: pointer; transition: all 0.2s;
    font-family: inherit; border-top: 2px solid transparent;
  }
  .tab.active {
    background: var(--card); color: var(--text);
    font-weight: 700; border-top-color: var(--accent);
  }

  /* â”€â”€ Content â”€â”€ */
  .content { padding: 28px 32px; max-width: 1200px; margin: 0 auto; }

  /* â”€â”€ KPI Cards â”€â”€ */
  .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); gap: 16px; margin-bottom: 32px; }
  .kpi-card {
    background: linear-gradient(135deg, var(--card) 0%, var(--card-hover) 100%);
    border: 1px solid var(--border); border-radius: 16px;
    padding: 20px 24px; position: relative; overflow: hidden;
  }
  .kpi-card .bg-icon { position: absolute; top: -10px; right: -10px; font-size: 56px; opacity: 0.06; }
  .kpi-label { font-size: 12px; color: var(--text-sub); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; font-weight: 600; }
  .kpi-value { font-size: 28px; font-weight: 800; line-height: 1.1; }
  .kpi-sub { font-size: 12px; color: var(--text-sub); margin-top: 6px; }
  .kpi-bar { position: absolute; bottom: 0; left: 0; right: 0; height: 3px; }

  /* â”€â”€ Section â”€â”€ */
  .section-title { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; margin-top: 8px; }
  .section-title .icon { font-size: 22px; }
  .section-title h2 { font-size: 20px; font-weight: 700; }
  .section-title .line { flex: 1; height: 1px; background: linear-gradient(90deg, var(--border), transparent); margin-left: 8px; }

  /* â”€â”€ Chart Container â”€â”€ */
  .chart-card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 16px; padding: 24px; margin-bottom: 24px;
  }
  .chart-card-title { font-size: 14px; font-weight: 700; margin-bottom: 16px; }
  .chart-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px; }

  /* â”€â”€ Staff Selector â”€â”€ */
  .staff-selector { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 20px; }
  .staff-btn {
    padding: 6px 14px; border-radius: 20px; border: 1px solid var(--border);
    background: var(--card); color: var(--text-sub); font-size: 12px;
    font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: inherit;
  }
  .staff-btn.active { border-color: var(--accent); background: rgba(108,92,231,0.2); color: var(--accent-light); }
  .staff-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
  .stat-item { padding: 8px 0; border-bottom: 1px solid var(--border); }
  .stat-label { font-size: 10px; color: var(--text-sub); margin-bottom: 2px; }
  .stat-value { font-size: 16px; font-weight: 700; }
  .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

  /* â”€â”€ Progress Bar â”€â”€ */
  .progress-item { margin-bottom: 14px; }
  .progress-header { display: flex; justify-content: space-between; margin-bottom: 4px; }
  .progress-label { font-size: 12px; color: var(--text-sub); }
  .progress-value { font-size: 12px; font-weight: 700; }
  .progress-track { height: 8px; border-radius: 4px; background: var(--border); overflow: hidden; }
  .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }

  /* â”€â”€ Scatter Grid â”€â”€ */
  .scatter-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
  .scatter-item {
    background: rgba(11,15,26,0.53); border-radius: 12px; padding: 14px 12px; text-align: center;
  }
  .scatter-name { font-size: 11px; font-weight: 600; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .scatter-rate { font-size: 18px; font-weight: 800; }
  .scatter-price { font-size: 11px; color: var(--text-sub); margin-top: 4px; }
  .badge {
    display: inline-block; padding: 2px 10px; border-radius: 20px;
    font-size: 12px; font-weight: 700; margin-top: 4px;
  }
  .badge.good { background: rgba(0,206,201,0.13); color: var(--success); border: 1px solid rgba(0,206,201,0.2); }
  .badge.bad { background: rgba(255,107,107,0.13); color: var(--danger); border: 1px solid rgba(255,107,107,0.2); }

  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* â”€â”€ Data Source Config â”€â”€ */
  .config-banner {
    background: linear-gradient(135deg, rgba(108,92,231,0.15), rgba(0,206,201,0.1));
    border: 1px solid rgba(108,92,231,0.3); border-radius: 12px;
    padding: 16px 20px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px;
  }
  .config-banner .icon { font-size: 24px; }
  .config-banner .text { font-size: 13px; color: var(--text-sub); line-height: 1.5; }
  .config-banner code { background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; font-size: 12px; color: var(--accent-light); }

  .footer { text-align: center; padding: 24px 32px 40px; font-size: 11px; color: rgba(136,145,165,0.53); }

  @media (max-width: 768px) {
    .chart-grid-2 { grid-template-columns: 1fr; }
    .staff-detail-grid { grid-template-columns: 1fr; }
    .content { padding: 16px; }
    .header { padding: 16px 16px 0; }
    .kpi-grid { grid-template-columns: 1fr 1fr; }
  }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="header">
  <div class="header-top">
    <div class="header-title">
      <div class="header-icon">âœ¦</div>
      <div>
        <h1>ã‚¨ã‚¹ãƒ†äº‹æ¥­éƒ¨ é€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        <div class="header-sub" id="periodLabel">æœŸé–“: 2026/02/18 ã€œ 2026/02/27ï¼ˆ10æ—¥é–“ï¼‰</div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <div class="live-badge">â— LIVE</div>
      <button class="refresh-btn" onclick="refreshData()" id="refreshBtn">ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°</button>
    </div>
  </div>
  <div class="tabs" id="tabs">
    <button class="tab active" data-tab="overview">ğŸ“Š å…¨ä½“æ¦‚è¦</button>
    <button class="tab" data-tab="new">ğŸ†• æ–°è¦å¥‘ç´„</button>
    <button class="tab" data-tab="onda">âš¡ ã‚ªãƒ³ãƒ€ãƒªãƒ•ãƒˆ</button>
    <button class="tab" data-tab="herb">ğŸŒ¿ ãƒãƒ¼ãƒ–</button>
    <button class="tab" data-tab="staff">ğŸ‘¤ ã‚¹ã‚¿ãƒƒãƒ•è©³ç´°</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONTENT â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="content">

  <!-- â”€â”€ Google Sheetsé€£æºè¨­å®šãƒãƒŠãƒ¼ â”€â”€ -->
  <div class="config-banner" id="configBanner">
    <div class="icon">ğŸ”—</div>
    <div class="text">
      <strong style="color:var(--text)">Google Sheets API é€£æºè¨­å®š</strong><br>
      ä¸‹è¨˜ã® <code>CONFIG</code> ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆHTMLãƒ•ã‚¡ã‚¤ãƒ«å†…ï¼‰ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã¨APIã‚­ãƒ¼ã‚’è¨­å®šã™ã‚‹ã¨ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ‡ãƒ¼ã‚¿ãŒåæ˜ ã•ã‚Œã¾ã™ã€‚
      è¨­å®šæ–¹æ³•ã¯ <a href="#" style="color:var(--accent-light)">README</a> ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
    </div>
  </div>

  <!-- TAB: Overview -->
  <div class="tab-content active" id="tab-overview">
    <div class="kpi-grid" id="kpi-overview"></div>

    <div class="section-title"><span class="icon">ğŸ“ˆ</span><h2>æ–°è¦å¥‘ç´„ç‡ åˆ†å¸ƒ</h2><div class="line"></div></div>
    <div class="chart-grid-2">
      <div class="chart-card"><canvas id="chartDistribution"></canvas></div>
      <div class="chart-card">
        <div class="chart-card-title">ã‚«ãƒ†ã‚´ãƒªåˆ¥ å¥‘ç´„ç‡æ¯”è¼ƒ</div>
        <canvas id="chartCategoryCompare"></canvas>
      </div>
    </div>

    <div class="section-title"><span class="icon">ğŸ†</span><h2>æ–°è¦å¥‘ç´„ç‡ ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP10</h2><div class="line"></div></div>
    <div class="chart-card"><canvas id="chartRanking" height="300"></canvas></div>
  </div>

  <!-- TAB: New Contracts -->
  <div class="tab-content" id="tab-new">
    <div class="kpi-grid" id="kpi-new"></div>
    <div class="section-title"><span class="icon">ğŸ’°</span><h2>ã‚¹ã‚¿ãƒƒãƒ•åˆ¥ æ–°è¦å¥‘ç´„å£²ä¸Š</h2><div class="line"></div></div>
    <div class="chart-card"><canvas id="chartNewSales" height="350"></canvas></div>
    <div class="section-title"><span class="icon">ğŸ¯</span><h2>å¥‘ç´„ç‡ vs å¥‘ç´„å˜ä¾¡</h2><div class="line"></div></div>
    <div class="chart-card"><div class="scatter-grid" id="scatterGrid"></div></div>
  </div>

  <!-- TAB: Onda -->
  <div class="tab-content" id="tab-onda">
    <div class="kpi-grid" id="kpi-onda"></div>
    <div class="section-title"><span class="icon">ğŸ“Š</span><h2>ã‚¹ã‚¿ãƒƒãƒ•åˆ¥ ã‚ªãƒ³ãƒ€ãƒªãƒ•ãƒˆå¥‘ç´„ç‡</h2><div class="line"></div></div>
    <div class="chart-card"><canvas id="chartOndaRate" height="400"></canvas></div>
    <div class="section-title"><span class="icon">ğŸ’</span><h2>ã‚ªãƒ³ãƒ€ãƒªãƒ•ãƒˆ å¥‘ç´„å˜ä¾¡åˆ†å¸ƒ</h2><div class="line"></div></div>
    <div class="chart-card"><canvas id="chartOndaPrice"></canvas></div>
  </div>

  <!-- TAB: Herb -->
  <div class="tab-content" id="tab-herb">
    <div class="kpi-grid" id="kpi-herb"></div>
    <div class="section-title"><span class="icon">ğŸ“Š</span><h2>ã‚¹ã‚¿ãƒƒãƒ•åˆ¥ ãƒãƒ¼ãƒ–å¥‘ç´„ç‡</h2><div class="line"></div></div>
    <div class="chart-card"><canvas id="chartHerbRate" height="400"></canvas></div>
    <div class="section-title"><span class="icon">ğŸ’</span><h2>ãƒãƒ¼ãƒ– å£²ä¸Š & å¥‘ç´„å˜ä¾¡</h2><div class="line"></div></div>
    <div class="chart-card"><canvas id="chartHerbSales"></canvas></div>
  </div>

  <!-- TAB: Staff Detail -->
  <div class="tab-content" id="tab-staff">
    <div style="font-size:13px;color:var(--text-sub);margin-bottom:8px">ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ</div>
    <div class="staff-selector" id="staffSelector"></div>
    <div class="staff-detail-grid">
      <div>
        <div class="chart-card" id="staffSummary"></div>
      </div>
      <div>
        <div class="chart-card">
          <div class="chart-card-title">ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒ¼ãƒ€ãƒ¼</div>
          <canvas id="chartRadar"></canvas>
        </div>
        <div class="chart-card" id="staffProgress"></div>
      </div>
    </div>
  </div>

</div>

<div class="footer" id="footerText">
  â€» Google Sheets APIé€£æºã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°å¯èƒ½ ãƒ» ãƒ‡ãƒ¼ã‚¿å–å¾—æ—¥: 2026/02/27
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG: Google Sheets API é€£æºè¨­å®š
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â‘  Google Cloud Console ã§ APIã‚­ãƒ¼ã‚’å–å¾—
// â‘¡ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ã€Œãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹å…¨å“¡ãŒé–²è¦§å¯ã€ã«è¨­å®š
// â‘¢ ä¸‹è¨˜ã®å€¤ã‚’åŸ‹ã‚ã‚‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CONFIG = {
  // Apps Script ã®ã€Œã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLï¼ˆ/execï¼‰ã€ã‚’è²¼ã‚‹
  WEB_APP_URL: 'https://script.google.com/macros/s/xxxxxxxxxxxxxxxx/exec',

  // GASå´ã«æ¸¡ã™ç¯„å›²ï¼ˆä»Šã¨åŒã˜æ–‡å­—åˆ—ã§OKï¼‰
  RANGE: 'ã‚¹ã‚¿ãƒƒãƒ•ã‚¢ãƒ©ãƒ¼ãƒˆ(ç›´å–¶)!A4:R39',

  STANDARDS: {
    newContractRate: 0.35,
    newContractUnitPrice: 50000,
    ondaContractRate: 0.33,
    herbContractRate: 0.4,
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATIC DATA (APIãŒæœªè¨­å®šã®å ´åˆã«ä½¿ç”¨)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STATIC_DATA = [
  { name:"å¥¥ç”°ãªãª", newAssigned:3, newContractRate:0.67, newContractUnitPrice:78900, ondaNew:0, ondaContractRate:0, ondaContractUnitPrice:0, herbNew:3, herbContractRate:0.67, herbSales:157800, herbUnitPrice:78900 },
  { name:"å°æ—ç‘ éŸ³", newAssigned:4, newContractRate:0.75, newContractUnitPrice:73900, ondaNew:1, ondaContractRate:1.0, ondaContractUnitPrice:85200, herbNew:3, herbContractRate:0.67, herbSales:136500, herbUnitPrice:68250 },
  { name:"å®¶å´èŒ", newAssigned:7, newContractRate:0.57, newContractUnitPrice:122800, ondaNew:4, ondaContractRate:0.75, ondaContractUnitPrice:74733, herbNew:3, herbContractRate:0.33, herbSales:267000, herbUnitPrice:267000 },
  { name:"ä¸­æ‘ç‘›é‡Œè¯", newAssigned:6, newContractRate:0.33, newContractUnitPrice:163200, ondaNew:3, ondaContractRate:0.33, ondaContractUnitPrice:170400, herbNew:3, herbContractRate:0.33, herbSales:156000, herbUnitPrice:156000 },
  { name:"è‹…å®¿è˜­è¯", newAssigned:6, newContractRate:0.33, newContractUnitPrice:10000, ondaNew:5, ondaContractRate:0.20, ondaContractUnitPrice:10000, herbNew:1, herbContractRate:1.0, herbSales:10000, herbUnitPrice:10000 },
  { name:"ä¸Šé‡å¸Œä¸–èœ", newAssigned:6, newContractRate:0.33, newContractUnitPrice:47600, ondaNew:5, ondaContractRate:0.40, ondaContractUnitPrice:47600, herbNew:1, herbContractRate:0.0, herbSales:0, herbUnitPrice:0 },
  { name:"å°è°·ç¾é¢¨å¤•", newAssigned:5, newContractRate:0.60, newContractUnitPrice:105300, ondaNew:3, ondaContractRate:0.33, ondaContractUnitPrice:119700, herbNew:2, herbContractRate:1.0, herbSales:196200, herbUnitPrice:98100 },
  { name:"è±Šé‡å„ªè¡£é¦™", newAssigned:5, newContractRate:0.60, newContractUnitPrice:87333, ondaNew:4, ondaContractRate:0.50, ondaContractUnitPrice:0, herbNew:1, herbContractRate:1.0, herbSales:262000, herbUnitPrice:262000 },
  { name:"æ–°äº•æ¡ƒé¦™", newAssigned:5, newContractRate:0.40, newContractUnitPrice:64100, ondaNew:2, ondaContractRate:0.50, ondaContractUnitPrice:14200, herbNew:3, herbContractRate:0.33, herbSales:114000, herbUnitPrice:114000 },
  { name:"æ¾å°¾é™½é¦™", newAssigned:9, newContractRate:0.44, newContractUnitPrice:54675, ondaNew:6, ondaContractRate:0.50, ondaContractUnitPrice:44900, herbNew:3, herbContractRate:0.33, herbSales:84000, herbUnitPrice:84000 },
  { name:"ç”°ä¸­çœŸè‰å¥ˆ", newAssigned:4, newContractRate:0.25, newContractUnitPrice:164000, ondaNew:1, ondaContractRate:0, ondaContractUnitPrice:0, herbNew:3, herbContractRate:0.33, herbSales:164000, herbUnitPrice:164000 },
  { name:"é•·å†…é¦™å¸†", newAssigned:4, newContractRate:0.25, newContractUnitPrice:85200, ondaNew:3, ondaContractRate:0.33, ondaContractUnitPrice:85200, herbNew:1, herbContractRate:0.0, herbSales:0, herbUnitPrice:0 },
  { name:"æ—ç”±èŠ½", newAssigned:6, newContractRate:0.33, newContractUnitPrice:12500, ondaNew:3, ondaContractRate:0.33, ondaContractUnitPrice:10000, herbNew:3, herbContractRate:0.33, herbSales:15000, herbUnitPrice:15000 },
  { name:"å¢—æœ¬çµæ„›", newAssigned:6, newContractRate:0.33, newContractUnitPrice:79250, ondaNew:2, ondaContractRate:0.50, ondaContractUnitPrice:49500, herbNew:4, herbContractRate:0.25, herbSales:109000, herbUnitPrice:109000 },
  { name:"å¤§æ²³åŸå‹é‡Œå¥ˆ", newAssigned:2, newContractRate:0.50, newContractUnitPrice:49500, ondaNew:2, ondaContractRate:0.50, ondaContractUnitPrice:49500, herbNew:0, herbContractRate:0.0, herbSales:0, herbUnitPrice:0 },
  { name:"ç´°ç”°ç‘ ã€…èŠ±", newAssigned:3, newContractRate:0.33, newContractUnitPrice:54000, ondaNew:0, ondaContractRate:0, ondaContractUnitPrice:0, herbNew:3, herbContractRate:0.33, herbSales:54000, herbUnitPrice:54000 },
  { name:"ç£¯ç”°ç¾é‚£", newAssigned:4, newContractRate:0.50, newContractUnitPrice:67500, ondaNew:2, ondaContractRate:1.0, ondaContractUnitPrice:67500, herbNew:2, herbContractRate:0.0, herbSales:0, herbUnitPrice:0 },
  { name:"è…åŸå‡›å¥ˆ", newAssigned:5, newContractRate:0.20, newContractUnitPrice:15000, ondaNew:3, ondaContractRate:0.33, ondaContractUnitPrice:15000, herbNew:2, herbContractRate:0.0, herbSales:0, herbUnitPrice:0 },
  { name:"é–¢å£ç¾å„ª", newAssigned:4, newContractRate:0.0, newContractUnitPrice:0, ondaNew:2, ondaContractRate:0, ondaContractUnitPrice:0, herbNew:2, herbContractRate:0.0, herbSales:0, herbUnitPrice:0 },
  { name:"è…è°·æ˜æ—¥é¦™", newAssigned:8, newContractRate:0.13, newContractUnitPrice:49500, ondaNew:7, ondaContractRate:0.14, ondaContractUnitPrice:49500, herbNew:1, herbContractRate:0.0, herbSales:0, herbUnitPrice:0 },
  { name:"åœŸå±‹", newAssigned:5, newContractRate:0.60, newContractUnitPrice:41733, ondaNew:3, ondaContractRate:0.67, ondaContractUnitPrice:42600, herbNew:2, herbContractRate:0.50, herbSales:40000, herbUnitPrice:40000 },
  { name:"å²¡æœ¬æ¸©", newAssigned:2, newContractRate:0.50, newContractUnitPrice:20000, ondaNew:0, ondaContractRate:0, ondaContractUnitPrice:0, herbNew:2, herbContractRate:0.50, herbSales:20000, herbUnitPrice:20000 },
  { name:"é–¢å·æèœ", newAssigned:3, newContractRate:0.0, newContractUnitPrice:0, ondaNew:2, ondaContractRate:0, ondaContractUnitPrice:0, herbNew:1, herbContractRate:0.0, herbSales:0, herbUnitPrice:0 },
  { name:"æ‘ä¸Šç‘ç´€", newAssigned:2, newContractRate:0.0, newContractUnitPrice:0, ondaNew:0, ondaContractRate:0, ondaContractUnitPrice:0, herbNew:2, herbContractRate:0.0, herbSales:0, herbUnitPrice:0 },
  { name:"ä¸Šãƒå €è‹±é›„", newAssigned:3, newContractRate:0.0, newContractUnitPrice:0, ondaNew:1, ondaContractRate:0, ondaContractUnitPrice:0, herbNew:2, herbContractRate:0.0, herbSales:0, herbUnitPrice:0 },
  { name:"å €ç¶¾èœ", newAssigned:3, newContractRate:0.0, newContractUnitPrice:0, ondaNew:1, ondaContractRate:0, ondaContractUnitPrice:0, herbNew:2, herbContractRate:0.0, herbSales:0, herbUnitPrice:0 },
  { name:"çŸ³æˆ¸è°·é¥å¥ˆ", newAssigned:1, newContractRate:0.0, newContractUnitPrice:0, ondaNew:1, ondaContractRate:0, ondaContractUnitPrice:0, herbNew:0, herbContractRate:0.0, herbSales:0, herbUnitPrice:0 },
  { name:"è„‡å±±å¤•èŠ½", newAssigned:1, newContractRate:0.0, newContractUnitPrice:0, ondaNew:0, ondaContractRate:0, ondaContractUnitPrice:0, herbNew:1, herbContractRate:0.0, herbSales:0, herbUnitPrice:0 },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Google Sheets API ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchFromGoogleSheets() {
  if (!CONFIG.WEB_APP_URL) {
    console.log('Webã‚¢ãƒ—ãƒªURLæœªè¨­å®š â†’ é™çš„ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨');
    return null;
  }

  // GASã¸ range ã‚’æ¸¡ã™
  const url = `${CONFIG.WEB_APP_URL}?range=${encodeURIComponent(CONFIG.RANGE)}`;

  try {
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`WebApp Error: ${res.status}`);
    const json = await res.json();

    // GASãŒ { values: [...] } ã‚’è¿”ã™æƒ³å®š
    return parseSheetData(json.values);
  } catch (err) {
    console.error('Webã‚¢ãƒ—ãƒªå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
    return null;
  }
}
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SPREADSHEET_ID}/values/${encodeURIComponent(CONFIG.RANGE)}?key=${CONFIG.API_KEY}`;

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`API Error: ${res.status}`);
    const json = await res.json();
    return parseSheetData(json.values);
  } catch (err) {
    console.error('Google Sheetså–å¾—ã‚¨ãƒ©ãƒ¼:', err);
    return null;
  }
}

// ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹
function parseSheetData(rows) {
  if (!rows || rows.length < 3) return null;

  // è¡Œ1=ãƒ˜ãƒƒãƒ€ãƒ¼, è¡Œ2=åŸºæº–å€¤, è¡Œ3ä»¥é™=ã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿
  const parsed = [];
  for (let i = 2; i < rows.length; i++) {
    const r = rows[i];
    if (!r[0] || r[0].trim() === '') continue;

    const pNum = (v) => {
      if (!v) return 0;
      const s = String(v).replace(/[Â¥,%,ã€€, ]/g, '').trim();
      return parseFloat(s) || 0;
    };
    const pPct = (v) => {
      if (!v) return 0;
      const s = String(v).replace(/[%,ã€€, ]/g, '').trim();
      const n = parseFloat(s);
      return n > 1 ? n / 100 : n || 0;
    };

    parsed.push({
      name: r[0].replace(/^\(ç›´\)/, ''),
      newAssigned: pNum(r[1]),
      newContractRate: pPct(r[2]),
      newContractUnitPrice: pNum(r[3]),
      ondaNew: pNum(r[4]),
      ondaContractRate: pPct(r[5]),
      ondaContractUnitPrice: pNum(r[6]),
      herbNew: pNum(r[7]),
      herbContractRate: pPct(r[8]),
      herbSales: pNum(r[9]),
      herbUnitPrice: pNum(r[10]),
    });
  }
  return parsed.filter(d => d.newAssigned > 0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE & HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let staffData = [];
let charts = {};
let selectedStaffIndex = 0;
const STD = CONFIG.STANDARDS;

const fmt = v => `Â¥${Math.round(v).toLocaleString()}`;
const pct = v => `${Math.round(v * 100)}%`;

function derive(d) {
  const newContracts = Math.round(d.newAssigned * d.newContractRate);
  const newSales = newContracts * d.newContractUnitPrice;
  const ondaContracts = Math.round(d.ondaNew * d.ondaContractRate);
  const ondaSales = ondaContracts * d.ondaContractUnitPrice;
  const herbContracts = Math.round(d.herbNew * d.herbContractRate);
  return { ...d, newContracts, newSales, ondaContracts, ondaSales, herbContracts };
}

function calcTotals(data) {
  const t = { totalAssigned:0, totalContracts:0, totalSales:0, totalOndaNew:0, totalOndaContracts:0, totalOndaSales:0, totalHerbNew:0, totalHerbContracts:0, totalHerbSales:0 };
  data.forEach(d => {
    t.totalAssigned += d.newAssigned;
    t.totalContracts += d.newContracts;
    t.totalSales += d.newSales;
    t.totalOndaNew += d.ondaNew;
    t.totalOndaContracts += d.ondaContracts;
    t.totalOndaSales += d.ondaSales;
    t.totalHerbNew += d.herbNew;
    t.totalHerbContracts += d.herbContracts;
    t.totalHerbSales += d.herbSales;
  });
  t.avgRate = t.totalAssigned ? t.totalContracts / t.totalAssigned : 0;
  t.avgUnit = t.totalContracts ? t.totalSales / t.totalContracts : 0;
  t.avgOndaRate = t.totalOndaNew ? t.totalOndaContracts / t.totalOndaNew : 0;
  t.avgHerbRate = t.totalHerbNew ? t.totalHerbContracts / t.totalHerbNew : 0;
  t.aboveStd = data.filter(d => d.newContractRate >= STD.newContractRate).length;
  t.staffCount = data.length;
  return t;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KPI RENDERER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function kpiHTML(label, value, sub, color, icon) {
  return `<div class="kpi-card">
    <div class="bg-icon">${icon}</div>
    <div class="kpi-label">${label}</div>
    <div class="kpi-value" style="color:${color}">${value}</div>
    ${sub ? `<div class="kpi-sub">${sub}</div>` : ''}
    <div class="kpi-bar" style="background:linear-gradient(90deg,${color},transparent)"></div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHART CONFIG (Chart.js defaults)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Chart.defaults.color = '#8891A5';
Chart.defaults.borderColor = '#1E2740';
Chart.defaults.font.family = "'DM Sans','Noto Sans JP',sans-serif";

function destroyChart(id) { if (charts[id]) { charts[id].destroy(); delete charts[id]; } }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll() {
  const t = calcTotals(staffData);

  // â”€â”€ Overview KPIs â”€â”€
  document.getElementById('kpi-overview').innerHTML = [
    kpiHTML('æ–°è¦æ‹…å½“æ•° åˆè¨ˆ', t.totalAssigned, `${t.staffCount}åã®ã‚¹ã‚¿ãƒƒãƒ•`, '#6C5CE7', 'ğŸ‘¥'),
    kpiHTML('æ–°è¦å¥‘ç´„æ•° åˆè¨ˆ', t.totalContracts, `å¥‘ç´„ç‡ ${pct(t.avgRate)}`, '#00CEC9', 'âœ…'),
    kpiHTML('æ–°è¦å£²ä¸Š åˆè¨ˆ', fmt(t.totalSales), `å¹³å‡å˜ä¾¡ ${fmt(t.avgUnit)}`, '#74B9FF', 'ğŸ’°'),
    kpiHTML('åŸºæº–é”æˆç‡', `${t.aboveStd}/${t.staffCount}`, `${Math.round(t.aboveStd/t.staffCount*100)}%ãŒåŸºæº–(35%)ä»¥ä¸Š`, t.aboveStd > t.staffCount/2 ? '#00CEC9' : '#FDCB6E', 'ğŸ¯'),
  ].join('');

  // â”€â”€ Distribution Chart â”€â”€
  const buckets = [{r:'0%',c:0,bg:'#FF6B6B'},{r:'1-25%',c:0,bg:'#E17055'},{r:'26-35%',c:0,bg:'#FDCB6E'},{r:'36-50%',c:0,bg:'#74B9FF'},{r:'51-75%',c:0,bg:'#A29BFE'},{r:'76-100%',c:0,bg:'#00CEC9'}];
  staffData.forEach(d => {
    const r = d.newContractRate * 100;
    if (r===0) buckets[0].c++; else if (r<=25) buckets[1].c++; else if (r<=35) buckets[2].c++; else if (r<=50) buckets[3].c++; else if (r<=75) buckets[4].c++; else buckets[5].c++;
  });
  destroyChart('dist');
  charts['dist'] = new Chart(document.getElementById('chartDistribution'), {
    type: 'bar',
    data: { labels: buckets.map(b=>b.r), datasets: [{ data: buckets.map(b=>b.c), backgroundColor: buckets.map(b=>b.bg), borderRadius: 6, barPercentage: 0.7 }] },
    options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,ticks:{stepSize:1}}} }
  });

  // â”€â”€ Category Compare â”€â”€
  destroyChart('catcmp');
  charts['catcmp'] = new Chart(document.getElementById('chartCategoryCompare'), {
    type: 'bar',
    data: {
      labels: ['æ–°è¦å…¨ä½“','ã‚ªãƒ³ãƒ€ãƒªãƒ•ãƒˆ','ãƒãƒ¼ãƒ–'],
      datasets: [
        { label:'å®Ÿç¸¾', data:[t.avgRate*100,t.avgOndaRate*100,t.avgHerbRate*100], backgroundColor:['#6C5CE7','#74B9FF','#00B894'], borderRadius:6, barPercentage:0.5 },
        { label:'åŸºæº–', data:[STD.newContractRate*100,STD.ondaContractRate*100,STD.herbContractRate*100], backgroundColor:['rgba(108,92,231,0.25)','rgba(116,185,255,0.25)','rgba(0,184,148,0.25)'], borderRadius:6, barPercentage:0.5 }
      ]
    },
    options: { responsive:true, plugins:{legend:{position:'bottom',labels:{boxWidth:12}}}, scales:{y:{beginAtZero:true,max:100,ticks:{callback:v=>v+'%'}}} }
  });

  // â”€â”€ Ranking TOP10 â”€â”€
  const ranked = [...staffData].sort((a,b)=>b.newContractRate-a.newContractRate).slice(0,10);
  destroyChart('rank');
  charts['rank'] = new Chart(document.getElementById('chartRanking'), {
    type: 'bar',
    data: {
      labels: ranked.map(d=>d.name),
      datasets: [{ data: ranked.map(d=>d.newContractRate*100), backgroundColor: ranked.map(d=>d.newContractRate>=STD.newContractRate?'#00CEC9':'#FDCB6E'), borderRadius:6, barPercentage:0.6 }]
    },
    options: { indexAxis:'y', responsive:true, plugins:{legend:{display:false}}, scales:{x:{beginAtZero:true,max:100,ticks:{callback:v=>v+'%'}}} }
  });

  // â”€â”€ New Contracts Tab â”€â”€
  document.getElementById('kpi-new').innerHTML = [
    kpiHTML('æ–°è¦æ‹…å½“æ•°', t.totalAssigned, '', '#6C5CE7', 'ğŸ“‹'),
    kpiHTML('æ–°è¦å¥‘ç´„æ•°', t.totalContracts, '', '#00CEC9', 'ğŸ“'),
    kpiHTML('æ–°è¦å¥‘ç´„ç‡', pct(t.avgRate), `åŸºæº–: ${pct(STD.newContractRate)}`, t.avgRate>=STD.newContractRate?'#00CEC9':'#FF6B6B', 'ğŸ“Š'),
    kpiHTML('æ–°è¦å£²ä¸Šåˆè¨ˆ', fmt(t.totalSales), '', '#74B9FF', 'ğŸ’´'),
    kpiHTML('å¹³å‡å¥‘ç´„å˜ä¾¡', fmt(t.avgUnit), `åŸºæº–: ${fmt(STD.newContractUnitPrice)}`, '#FD79A8', 'ğŸ’'),
  ].join('');

  const salesSorted = [...staffData].sort((a,b)=>b.newSales-a.newSales).slice(0,15);
  destroyChart('newsales');
  charts['newsales'] = new Chart(document.getElementById('chartNewSales'), {
    type: 'bar',
    data: {
      labels: salesSorted.map(d=>d.name),
      datasets: [{ data: salesSorted.map(d=>d.newSales), backgroundColor: salesSorted.map((_,i)=>i<3?'#00CEC9':i<7?'#74B9FF':'#6C5CE7'), borderRadius:6, barPercentage:0.6 }]
    },
    options: { indexAxis:'y', responsive:true, plugins:{legend:{display:false}}, scales:{x:{ticks:{callback:v=>'Â¥'+(v/1000).toFixed(0)+'K'}}} }
  });

  // Scatter-like grid
  const contracted = staffData.filter(d=>d.newContracts>0);
  document.getElementById('scatterGrid').innerHTML = contracted.map(d => {
    const good = d.newContractRate >= STD.newContractRate;
    return `<div class="scatter-item" style="border:1px solid ${good?'rgba(0,206,201,0.27)':'rgba(255,107,107,0.27)'}">
      <div class="scatter-name">${d.name}</div>
      <div class="scatter-rate" style="color:${good?'#00CEC9':'#FDCB6E'}">${pct(d.newContractRate)}</div>
      <div class="scatter-price">${fmt(d.newContractUnitPrice)}</div>
      <span class="badge ${good?'good':'bad'}">${good?'é”æˆ':'æœªé”'}</span>
    </div>`;
  }).join('');

  // â”€â”€ Onda Tab â”€â”€
  document.getElementById('kpi-onda').innerHTML = [
    kpiHTML('ã‚ªãƒ³ãƒ€æ–°è¦æ•°', t.totalOndaNew, '', '#74B9FF', 'âš¡'),
    kpiHTML('ã‚ªãƒ³ãƒ€å¥‘ç´„æ•°', t.totalOndaContracts, '', '#00CEC9', 'âœ¨'),
    kpiHTML('ã‚ªãƒ³ãƒ€å¥‘ç´„ç‡', pct(t.avgOndaRate), `åŸºæº–: ${pct(STD.ondaContractRate)}`, t.avgOndaRate>=STD.ondaContractRate?'#00CEC9':'#FF6B6B', 'ğŸ“ˆ'),
    kpiHTML('ã‚ªãƒ³ãƒ€å£²ä¸Šåˆè¨ˆ', fmt(t.totalOndaSales), '', '#FD79A8', 'ğŸ’°'),
  ].join('');

  const ondaData = staffData.filter(d=>d.ondaNew>0).sort((a,b)=>b.ondaContractRate-a.ondaContractRate);
  destroyChart('ondarate');
  charts['ondarate'] = new Chart(document.getElementById('chartOndaRate'), {
    type: 'bar',
    data: {
      labels: ondaData.map(d=>d.name),
      datasets: [{ data: ondaData.map(d=>d.ondaContractRate*100), backgroundColor: ondaData.map(d=>d.ondaContractRate>=STD.ondaContractRate?'#00CEC9':d.ondaContractRate>0?'#FDCB6E':'#FF6B6B'), borderRadius:6, barPercentage:0.6 }]
    },
    options: { indexAxis:'y', responsive:true, plugins:{legend:{display:false}}, scales:{x:{beginAtZero:true,max:100,ticks:{callback:v=>v+'%'}}} }
  });

  const ondaPrice = ondaData.filter(d=>d.ondaContractUnitPrice>0).sort((a,b)=>b.ondaContractUnitPrice-a.ondaContractUnitPrice);
  destroyChart('ondaprice');
  charts['ondaprice'] = new Chart(document.getElementById('chartOndaPrice'), {
    type: 'bar',
    data: {
      labels: ondaPrice.map(d=>d.name),
      datasets: [{ data: ondaPrice.map(d=>d.ondaContractUnitPrice), backgroundColor: ondaPrice.map((_,i)=>i%2===0?'#74B9FF':'#A29BFE'), borderRadius:6, barPercentage:0.6 }]
    },
    options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{ticks:{callback:v=>'Â¥'+(v/1000).toFixed(0)+'K'}}} }
  });

  // â”€â”€ Herb Tab â”€â”€
  document.getElementById('kpi-herb').innerHTML = [
    kpiHTML('ãƒãƒ¼ãƒ–æ–°è¦æ•°', t.totalHerbNew, '', '#00B894', 'ğŸŒ¿'),
    kpiHTML('ãƒãƒ¼ãƒ–å¥‘ç´„æ•°', t.totalHerbContracts, '', '#00CEC9', 'âœ…'),
    kpiHTML('ãƒãƒ¼ãƒ–å¥‘ç´„ç‡', pct(t.avgHerbRate), `åŸºæº–: ${pct(STD.herbContractRate)}`, t.avgHerbRate>=STD.herbContractRate?'#00CEC9':'#FF6B6B', 'ğŸ¯'),
    kpiHTML('ãƒãƒ¼ãƒ–å£²ä¸Šåˆè¨ˆ', fmt(t.totalHerbSales), '', '#FD79A8', 'ğŸ’°'),
  ].join('');

  const herbData = staffData.filter(d=>d.herbNew>0).sort((a,b)=>b.herbContractRate-a.herbContractRate);
  destroyChart('herbrate');
  charts['herbrate'] = new Chart(document.getElementById('chartHerbRate'), {
    type: 'bar',
    data: {
      labels: herbData.map(d=>d.name),
      datasets: [{ data: herbData.map(d=>d.herbContractRate*100), backgroundColor: herbData.map(d=>d.herbContractRate>=STD.herbContractRate?'#00CEC9':d.herbContractRate>0?'#FDCB6E':'#FF6B6B'), borderRadius:6, barPercentage:0.6 }]
    },
    options: { indexAxis:'y', responsive:true, plugins:{legend:{display:false}}, scales:{x:{beginAtZero:true,max:100,ticks:{callback:v=>v+'%'}}} }
  });

  const herbSales = herbData.filter(d=>d.herbSales>0).sort((a,b)=>b.herbSales-a.herbSales);
  destroyChart('herbsales');
  charts['herbsales'] = new Chart(document.getElementById('chartHerbSales'), {
    type: 'bar',
    data: {
      labels: herbSales.map(d=>d.name),
      datasets: [
        { label:'å£²ä¸Š', data: herbSales.map(d=>d.herbSales), backgroundColor:'#00B894', borderRadius:6, barPercentage:0.4 },
        { label:'å¥‘ç´„å˜ä¾¡', data: herbSales.map(d=>d.herbUnitPrice), backgroundColor:'rgba(162,155,254,0.6)', borderRadius:6, barPercentage:0.4 }
      ]
    },
    options: { responsive:true, plugins:{legend:{position:'bottom',labels:{boxWidth:12}}}, scales:{y:{ticks:{callback:v=>'Â¥'+(v/1000).toFixed(0)+'K'}}} }
  });

  // â”€â”€ Staff Detail Tab â”€â”€
  renderStaffSelector();
  renderStaffDetail(staffData[selectedStaffIndex] || staffData[0]);
}

function renderStaffSelector() {
  const sorted = [...staffData].sort((a,b)=>b.newContractRate-a.newContractRate);
  document.getElementById('staffSelector').innerHTML = sorted.map((d,i) =>
    `<button class="staff-btn ${i===selectedStaffIndex?'active':''}" onclick="selectStaff(${staffData.indexOf(d)})">${d.name}</button>`
  ).join('');
}

function selectStaff(idx) {
  selectedStaffIndex = idx;
  renderStaffSelector();
  renderStaffDetail(staffData[idx]);
}

function renderStaffDetail(s) {
  if (!s) return;
  const items = [
    {l:'æ–°è¦æ‹…å½“æ•°',v:s.newAssigned}, {l:'æ–°è¦å¥‘ç´„æ•°',v:s.newContracts},
    {l:'æ–°è¦å¥‘ç´„ç‡',v:pct(s.newContractRate),c:s.newContractRate>=STD.newContractRate?'#00CEC9':'#FF6B6B'},
    {l:'æ–°è¦å¥‘ç´„å˜ä¾¡',v:fmt(s.newContractUnitPrice)}, {l:'æ–°è¦å£²ä¸Š',v:fmt(s.newSales),c:'#74B9FF'},
    {l:'ã‚ªãƒ³ãƒ€ãƒªãƒ•ãƒˆæ–°è¦æ•°',v:s.ondaNew},
    {l:'ã‚ªãƒ³ãƒ€ãƒªãƒ•ãƒˆå¥‘ç´„ç‡',v:pct(s.ondaContractRate),c:s.ondaContractRate>=STD.ondaContractRate?'#00CEC9':'#FF6B6B'},
    {l:'ã‚ªãƒ³ãƒ€ãƒªãƒ•ãƒˆå¥‘ç´„å˜ä¾¡',v:fmt(s.ondaContractUnitPrice)}, {l:'ãƒãƒ¼ãƒ–æ–°è¦æ•°',v:s.herbNew},
    {l:'ãƒãƒ¼ãƒ–å¥‘ç´„ç‡',v:pct(s.herbContractRate),c:s.herbContractRate>=STD.herbContractRate?'#00CEC9':'#FF6B6B'},
    {l:'ãƒãƒ¼ãƒ–å£²ä¸Š',v:fmt(s.herbSales),c:'#00B894'}, {l:'ãƒãƒ¼ãƒ–å¥‘ç´„å˜ä¾¡',v:fmt(s.herbUnitPrice)},
  ];

  document.getElementById('staffSummary').innerHTML = `
    <div style="font-size:22px;font-weight:800;margin-bottom:4px">${s.name}</div>
    <div style="font-size:12px;color:var(--text-sub);margin-bottom:20px">å€‹äººæˆç¸¾ã‚µãƒãƒªãƒ¼</div>
    <div class="stat-grid">${items.map(i=>`
      <div class="stat-item">
        <div class="stat-label">${i.l}</div>
        <div class="stat-value" style="color:${i.c||'var(--text)'}">${i.v}</div>
      </div>`).join('')}
    </div>`;

  // Radar
  destroyChart('radar');
  charts['radar'] = new Chart(document.getElementById('chartRadar'), {
    type: 'radar',
    data: {
      labels: ['æ–°è¦å¥‘ç´„ç‡','ã‚ªãƒ³ãƒ€ãƒªãƒ•ãƒˆå¥‘ç´„ç‡','ãƒãƒ¼ãƒ–å¥‘ç´„ç‡','æ‹…å½“æ•°','å˜ä¾¡ã‚¹ã‚³ã‚¢'],
      datasets: [{
        label: s.name,
        data: [s.newContractRate*100, s.ondaContractRate*100, s.herbContractRate*100, Math.min(s.newAssigned/10*100,100), Math.min(s.newContractUnitPrice/200000*100,100)],
        backgroundColor: 'rgba(108,92,231,0.3)', borderColor: '#6C5CE7', borderWidth: 2, pointBackgroundColor: '#6C5CE7'
      }]
    },
    options: { responsive:true, plugins:{legend:{display:false}}, scales:{r:{beginAtZero:true,max:100,ticks:{stepSize:20,color:'#8891A5'},grid:{color:'#1E2740'},pointLabels:{color:'#8891A5',font:{size:11}}}} }
  });

  // Progress bars
  const progs = [
    {l:'æ–°è¦å¥‘ç´„ç‡',v:s.newContractRate,t:STD.newContractRate},
    {l:'ã‚ªãƒ³ãƒ€ãƒªãƒ•ãƒˆå¥‘ç´„ç‡',v:s.ondaContractRate,t:STD.ondaContractRate},
    {l:'ãƒãƒ¼ãƒ–å¥‘ç´„ç‡',v:s.herbContractRate,t:STD.herbContractRate},
  ];
  document.getElementById('staffProgress').innerHTML = `
    <div class="chart-card-title">åŸºæº–é”æˆçŠ¶æ³</div>
    ${progs.map(p=>{
      const good = p.v >= p.t;
      const w = Math.min(p.v/p.t*100, 100);
      return `<div class="progress-item">
        <div class="progress-header">
          <span class="progress-label">${p.l}</span>
          <span class="progress-value" style="color:${good?'#00CEC9':'#FF6B6B'}">${pct(p.v)} / ${pct(p.t)}</span>
        </div>
        <div class="progress-track">
          <div class="progress-fill" style="width:${w}%;background:linear-gradient(90deg,${good?'#00CEC9,#00B894':'#FF6B6B,#E17055'})"></div>
        </div>
      </div>`;
    }).join('')}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA REFRESH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function refreshData() {
  const btn = document.getElementById('refreshBtn');
  btn.classList.add('loading');
  btn.textContent = 'â³ å–å¾—ä¸­...';

  const apiData = await fetchFromGoogleSheets();
  if (apiData && apiData.length > 0) {
    staffData = apiData.map(derive);
    document.getElementById('configBanner').style.display = 'none';
    document.getElementById('footerText').textContent = `â€» Google Sheets APIã‹ã‚‰ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å–å¾— ãƒ» æœ€çµ‚æ›´æ–°: ${new Date().toLocaleString('ja-JP')}`;
  } else {
    staffData = STATIC_DATA.filter(d => d.newAssigned > 0).map(derive);
  }

  renderAll();
  btn.classList.remove('loading');
  btn.textContent = 'ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('tabs').addEventListener('click', e => {
  if (!e.target.classList.contains('tab')) return;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  e.target.classList.add('active');
  document.getElementById('tab-' + e.target.dataset.tab).classList.add('active');
  // Re-render charts for the newly visible tab (Chart.js needs visible canvas)
  setTimeout(() => renderAll(), 50);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async function init() {
  await refreshData();
})();
</script>
</body>
</html>
