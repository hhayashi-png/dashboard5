<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>å–¶æ¥­ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{--green-dark:#1B7A4E;--green-main:#2EAD6D;--green-light:#E8F5EE;--green-pale:#F0FAF4;--pink-soft:#FFE4EC;--pink-accent:#FF8FAB;--pink-text:#D4547A;--blue-soft:#E3F2FD;--blue-accent:#64B5F6;--blue-text:#3478BE;--white:#FFF;--gray-50:#FAFAFA;--gray-100:#F5F5F5;--gray-200:#EEE;--gray-300:#E0E0E0;--gray-500:#9E9E9E;--gray-700:#616161;--gray-900:#212121;--shadow-sm:0 1px 3px rgba(0,0,0,.06);--shadow-lg:0 8px 24px rgba(0,0,0,.1);--radius-sm:10px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans JP',sans-serif;background:linear-gradient(145deg,var(--green-pale),var(--white) 40%,var(--blue-soft));min-height:100vh;color:var(--gray-900);-webkit-font-smoothing:antialiased;max-width:480px;margin:0 auto;padding-bottom:80px}
.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(145deg,var(--green-pale),var(--white) 40%,var(--blue-soft));display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;transition:opacity .4s}
.loading-overlay.hidden{opacity:0;pointer-events:none}
.loading-spinner{width:48px;height:48px;border:4px solid var(--green-light);border-top-color:var(--green-main);border-radius:50%;animation:spin .8s linear infinite;margin-bottom:16px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-family:'Zen Maru Gothic',sans-serif;font-size:14px;color:var(--green-dark);font-weight:500}
.loading-sub{font-size:11px;color:var(--gray-500);margin-top:6px}
.error-screen{display:none;padding:40px 24px;text-align:center}
.error-screen.show{display:block}
.error-icon{font-size:48px;margin-bottom:12px}
.error-msg{font-size:14px;color:var(--gray-700);line-height:1.6;margin-bottom:16px}
.error-detail{font-size:11px;color:var(--gray-500);margin-bottom:16px;word-break:break-all}
.retry-btn{padding:10px 24px;border-radius:20px;border:none;background:var(--green-main);color:#fff;font-size:14px;font-family:'Noto Sans JP',sans-serif;font-weight:600;cursor:pointer;box-shadow:0 2px 8px rgba(46,173,109,.3)}
.header{background:linear-gradient(135deg,var(--green-dark),var(--green-main));padding:20px 20px 24px;color:#fff;position:sticky;top:0;z-index:100;box-shadow:var(--shadow-lg)}
.header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.header h1{font-family:'Zen Maru Gothic',sans-serif;font-size:18px;font-weight:700}
.header .date-label{font-size:12px;opacity:.85}
.header .period{font-size:11px;opacity:.7;margin-top:2px}
.refresh-btn{background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3);color:#fff;padding:4px 10px;border-radius:16px;font-size:11px;cursor:pointer;font-family:'Noto Sans JP',sans-serif}
.refresh-btn:active{background:rgba(255,255,255,.35)}
.refresh-btn.loading{opacity:.6;pointer-events:none}
.tabs{display:flex;gap:6px;padding:12px 16px;background:var(--white);border-bottom:1px solid var(--gray-200);overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab{flex-shrink:0;padding:8px 16px;border-radius:20px;font-size:13px;font-weight:500;border:none;cursor:pointer;transition:all .25s;background:var(--gray-100);color:var(--gray-700);font-family:'Noto Sans JP',sans-serif}
.tab.active{background:var(--green-main);color:#fff;box-shadow:0 2px 8px rgba(46,173,109,.3)}
.content{padding:16px}
.section-title{font-family:'Zen Maru Gothic',sans-serif;font-size:15px;font-weight:700;color:var(--green-dark);margin:20px 0 12px;display:flex;align-items:center;gap:6px}
.section-title:first-child{margin-top:4px}
.summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:8px}
.summary-card{background:var(--white);border-radius:var(--radius-sm);padding:14px;box-shadow:var(--shadow-sm);border:1px solid var(--gray-200)}
.summary-card.green{border-left:4px solid var(--green-main)}.summary-card.pink{border-left:4px solid var(--pink-accent)}.summary-card.blue{border-left:4px solid var(--blue-accent)}
.summary-card .label{font-size:11px;color:var(--gray-500);font-weight:500;margin-bottom:4px}
.summary-card .value{font-size:22px;font-weight:700;font-family:'Zen Maru Gothic',sans-serif}
.summary-card.green .value{color:var(--green-dark)}.summary-card.pink .value{color:var(--pink-text)}.summary-card.blue .value{color:var(--blue-text)}
.summary-card .sub{font-size:10px;color:var(--gray-500);margin-top:2px}
.ranking-list{display:flex;flex-direction:column;gap:8px}
.staff-row{background:var(--white);border-radius:var(--radius-sm);padding:12px 14px;box-shadow:var(--shadow-sm);border:1px solid var(--gray-200);display:flex;align-items:center;gap:10px;cursor:pointer;transition:all .2s}
.staff-row:active{transform:scale(.98);background:var(--green-pale)}
.rank-badge{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0}
.rank-1{background:linear-gradient(135deg,#FFD700,#FFA000);color:#fff}.rank-2{background:linear-gradient(135deg,#C0C0C0,#9E9E9E);color:#fff}.rank-3{background:linear-gradient(135deg,#CD7F32,#A0522D);color:#fff}.rank-other{background:var(--gray-100);color:var(--gray-500)}
.staff-info{flex:1;min-width:0}.staff-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.staff-stats{display:flex;gap:8px;margin-top:3px}.staff-stat{font-size:10px;color:var(--gray-500)}.staff-stat span{font-weight:600}.staff-stat.green span{color:var(--green-main)}.staff-stat.pink span{color:var(--pink-text)}
.staff-arrow{color:var(--gray-300);font-size:16px;flex-shrink:0}
.progress-bar{height:6px;background:var(--gray-100);border-radius:3px;overflow:hidden;margin-top:6px}
.progress-fill{height:100%;border-radius:3px;transition:width .6s}.progress-fill.green{background:linear-gradient(90deg,var(--green-main),#4FD080)}.progress-fill.pink{background:linear-gradient(90deg,var(--pink-accent),#FFB6C8)}.progress-fill.blue{background:linear-gradient(90deg,var(--blue-accent),#90CAF9)}
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.4);z-index:200;display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px)}
.modal-overlay.active{display:flex}
.modal{background:var(--white);width:100%;max-width:480px;max-height:88vh;border-radius:20px 20px 0 0;overflow-y:auto;animation:slideUp .35s ease;padding-bottom:env(safe-area-inset-bottom,32px)}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:36px;height:4px;background:var(--gray-300);border-radius:2px;margin:10px auto 0}
.modal-header{padding:16px 20px 12px;border-bottom:1px solid var(--gray-200);display:flex;justify-content:space-between;align-items:center}
.modal-header h2{font-family:'Zen Maru Gothic',sans-serif;font-size:17px;font-weight:700;color:var(--green-dark)}
.modal-close{width:32px;height:32px;border-radius:50%;border:none;background:var(--gray-100);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--gray-500)}
.modal-body{padding:16px 20px}
.skill-section{margin-bottom:16px}.skill-bar-item{margin-bottom:10px}
.skill-bar-label{display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px}.skill-bar-label .name{color:var(--gray-700);font-weight:500}.skill-bar-label .val{font-weight:700}
.skill-bar{height:8px;background:var(--gray-100);border-radius:4px;overflow:hidden}
.skill-bar-fill{height:100%;border-radius:4px;transition:width .8s cubic-bezier(.25,.46,.45,.94)}
.ai-advice{background:linear-gradient(135deg,var(--green-pale),var(--pink-soft) 50%,var(--blue-soft));border-radius:var(--radius-sm);padding:16px;margin-top:12px;border:1px solid var(--green-light)}
.ai-advice-header{display:flex;align-items:center;gap:6px;margin-bottom:8px;font-size:13px;font-weight:700;color:var(--green-dark)}
.ai-badge{background:var(--green-main);color:#fff;font-size:9px;padding:2px 6px;border-radius:8px;font-weight:700}
.ai-advice p{font-size:12.5px;line-height:1.7;color:var(--gray-700)}
.ai-advice .highlight{background:rgba(46,173,109,.15);padding:1px 4px;border-radius:3px;font-weight:600;color:var(--green-dark)}
.ai-advice .improve{background:rgba(255,143,171,.2);padding:1px 4px;border-radius:3px;font-weight:600;color:var(--pink-text)}
.modal-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px}
.modal-stat{text-align:center;background:var(--gray-50);padding:10px 6px;border-radius:var(--radius-sm)}
.modal-stat .num{font-size:18px;font-weight:700;font-family:'Zen Maru Gothic',sans-serif}.modal-stat .lbl{font-size:10px;color:var(--gray-500);margin-top:2px}
.modal-stat.g .num{color:var(--green-dark)}.modal-stat.p .num{color:var(--pink-text)}.modal-stat.b .num{color:var(--blue-text)}
.tab-panel{display:none}.tab-panel.active{display:block}
.comparison-item{margin-bottom:14px}.comparison-label{display:flex;justify-content:space-between;margin-bottom:4px}
.comparison-name{font-size:12px;font-weight:500;color:var(--gray-700);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:55%}
.comparison-val{font-size:12px;font-weight:700;color:var(--green-dark)}
.select-wrapper{position:relative;margin-bottom:16px}
.custom-select{width:100%;padding:10px 14px;border-radius:var(--radius-sm);border:2px solid var(--green-light);background:var(--white);font-size:14px;font-family:'Noto Sans JP',sans-serif;font-weight:500;color:var(--gray-900);appearance:none;cursor:pointer;outline:none}
.custom-select:focus{border-color:var(--green-main)}
.select-arrow{position:absolute;right:14px;top:50%;transform:translateY(-50%);pointer-events:none;color:var(--green-main)}
.alert-row{border-left:4px solid var(--pink-accent)!important}
.no-data{text-align:center;padding:24px;color:var(--gray-500);font-size:13px}
.last-update{text-align:center;padding:16px;font-size:10px;color:var(--gray-500)}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.animate-in{animation:fadeIn .4s ease forwards}
.delay-1{animation-delay:.05s;opacity:0}.delay-2{animation-delay:.1s;opacity:0}.delay-3{animation-delay:.15s;opacity:0}.delay-4{animation-delay:.2s;opacity:0}
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text">ğŸŒ¿ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</div>
  <div class="loading-sub">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰æœ€æ–°æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™</div>
</div>

<div class="error-screen" id="errorScreen">
  <div class="error-icon">ğŸ˜¥</div>
  <div class="error-msg">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</div>
  <div class="error-detail" id="errorDetail"></div>
  <button class="retry-btn" onclick="loadData()">ğŸ”„ å†èª­ã¿è¾¼ã¿</button>
</div>

<div id="mainApp" style="display:none;">
  <div class="header">
    <div class="header-top">
      <h1>ğŸŒ¿ å–¶æ¥­ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h1>
      <button class="refresh-btn" id="refreshBtn" onclick="refreshData()">ğŸ”„ æ›´æ–°</button>
    </div>
    <div class="date-label" id="todayDate"></div>
    <div class="period" id="periodLabel">é›†è¨ˆæœŸé–“ï¼šèª­è¾¼ä¸­...</div>
  </div>
  <div class="tabs">
    <button class="tab active" onclick="switchTab('overview',this)">ğŸ“Š å…¨ä½“</button>
    <button class="tab" onclick="switchTab('ranking',this)">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
    <button class="tab" onclick="switchTab('individual',this)">ğŸ‘¤ å€‹äººåˆ†æ</button>
    <button class="tab" onclick="switchTab('alert',this)">ğŸš¨ ã‚¢ãƒ©ãƒ¼ãƒˆ</button>
  </div>
  <div class="content">
    <div class="tab-panel active" id="tab-overview">
      <div class="section-title animate-in">ğŸ“ˆ å…¨ä½“ã‚µãƒãƒªãƒ¼</div>
      <div class="summary-grid">
        <div class="summary-card green animate-in delay-1"><div class="label">æ–°è¦å¥‘ç´„ç‡ï¼ˆå¹³å‡ï¼‰</div><div class="value" id="avgNewRate">--</div><div class="sub" id="subNewRate">åŸºæº–: --%</div></div>
        <div class="summary-card pink animate-in delay-2"><div class="label">ãƒãƒ¼ãƒ–æ–°è¦å¥‘ç´„ç‡ï¼ˆå¹³å‡ï¼‰</div><div class="value" id="avgHerbRate">--</div><div class="sub" id="subHerbRate">åŸºæº–: --%</div></div>
        <div class="summary-card blue animate-in delay-3"><div class="label">ã‚ªãƒ³ãƒ€ãƒªãƒ•ãƒˆå¥‘ç´„ç‡ï¼ˆå¹³å‡ï¼‰</div><div class="value" id="avgOndaRate">--</div><div class="sub" id="subOndaRate">åŸºæº–: --%</div></div>
        <div class="summary-card green animate-in delay-4"><div class="label">æ–°è¦å¥‘ç´„å˜ä¾¡ï¼ˆå¹³å‡ï¼‰</div><div class="value" id="avgUnitPrice">--</div><div class="sub" id="subUnitPrice">åŸºæº–: --</div></div>
      </div>
      <div class="section-title animate-in">ğŸŒŸ ãƒˆãƒƒãƒ—ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ¼</div>
      <div id="topPerformers" class="ranking-list"></div>
      <div class="section-title animate-in" style="margin-top:24px">âš ï¸ ã‚µãƒãƒ¼ãƒˆãŒå¿…è¦</div>
      <div id="needsSupport" class="ranking-list"></div>
    </div>
    <div class="tab-panel" id="tab-ranking">
      <div class="section-title">ğŸ… æ–°è¦å¥‘ç´„ç‡ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div><div id="rankNewRate" class="ranking-list"></div>
      <div class="section-title" style="margin-top:20px">ğŸ’° å¥‘ç´„å˜ä¾¡ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div><div id="rankUnitPrice" class="ranking-list"></div>
      <div class="section-title" style="margin-top:20px">ğŸŒ¿ ãƒãƒ¼ãƒ–å¥‘ç´„å£²ä¸Šãƒ©ãƒ³ã‚­ãƒ³ã‚°</div><div id="rankHerbSales" class="ranking-list"></div>
    </div>
    <div class="tab-panel" id="tab-individual">
      <div class="section-title">ğŸ‘¤ ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠ</div>
      <div class="select-wrapper"><select class="custom-select" id="staffSelect" onchange="showIndividual()"><option value="">é¸æŠã—ã¦ãã ã•ã„</option></select><div class="select-arrow">â–¼</div></div>
      <div id="individualContent"></div>
    </div>
    <div class="tab-panel" id="tab-alert">
      <div class="section-title">ğŸš¨ åŸºæº–æœªé”ã‚¢ãƒ©ãƒ¼ãƒˆ</div>
      <p style="font-size:12px;color:var(--gray-500);margin-bottom:12px;">å„æŒ‡æ¨™ã§åŸºæº–å€¤ã‚’ä¸‹å›ã£ã¦ã„ã‚‹ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¡¨ç¤º</p>
      <div id="alertList" class="ranking-list"></div>
    </div>
  </div>
  <div class="last-update" id="lastUpdate">æœ€çµ‚æ›´æ–°: --</div>
</div>

<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-header"><h2 id="modalTitle">--</h2><button class="modal-close" onclick="closeModalDirect()">âœ•</button></div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script>
// ============================================================
// GAS ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
// ============================================================
var GAS_BASE = "https://script.google.com/macros/s/AKfycbwtOwSrE5mRtfWswHKq9ju3ejL9fUTxj_FLuFRrBAZJmepqcWdR96gOCvXGjofx5Rhs/exec";

var staffData = [];
var criteria = {};
var activeStaff = [];

// ============================================================
// JSONP ã§ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆCORSå®Œå…¨å›é¿ï¼‰
// ============================================================
function loadDataViaJSONP(callbackName) {
  return new Promise(function(resolve, reject) {
    var timeout = setTimeout(function() {
      cleanup();
      reject(new Error("ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ15ç§’ï¼‰"));
    }, 15000);

    function cleanup() {
      clearTimeout(timeout);
      delete window[callbackName];
      var el = document.getElementById("jsonp_" + callbackName);
      if (el) el.remove();
    }

    window[callbackName] = function(data) {
      cleanup();
      resolve(data);
    };

    var script = document.createElement("script");
    script.id = "jsonp_" + callbackName;
    script.src = GAS_BASE + "?callback=" + callbackName + "&_t=" + Date.now();
    script.onerror = function() {
      cleanup();
      reject(new Error("ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼"));
    };
    document.body.appendChild(script);
  });
}

function loadData() {
  document.getElementById('loadingOverlay').classList.remove('hidden');
  document.getElementById('errorScreen').classList.remove('show');
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('errorDetail').textContent = '';

  loadDataViaJSONP("gc_" + Date.now()).then(function(data) {
    applyData(data);
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('loadingOverlay').classList.add('hidden');
  }).catch(function(err) {
    document.getElementById('errorDetail').textContent = err.message;
    document.getElementById('errorScreen').classList.add('show');
    document.getElementById('loadingOverlay').classList.add('hidden');
  });
}

function refreshData() {
  var btn = document.getElementById('refreshBtn');
  btn.classList.add('loading'); btn.textContent = 'â³ æ›´æ–°ä¸­';
  loadDataViaJSONP("gr_" + Date.now()).then(function(data) {
    applyData(data);
  }).catch(function(err) {
    alert("æ›´æ–°å¤±æ•—: " + err.message);
  }).finally(function() {
    btn.classList.remove('loading'); btn.textContent = 'ğŸ”„ æ›´æ–°';
  });
}

function applyData(data) {
  staffData = data.staff || [];
  criteria = data.criteria || {newRate:35,ondaRate:33,herbRate:40,unitPrice:50000};
  activeStaff = staffData.filter(function(s){return s.newCount>0&&(s.newRate>0||s.ondaRate>0||s.herbRate>0)});
  document.getElementById('periodLabel').textContent='é›†è¨ˆæœŸé–“ï¼š'+(data.period?data.period.start:'--')+' ã€œ '+(data.period?data.period.end:'--');
  document.getElementById('todayDate').textContent=new Date().toLocaleDateString('ja-JP');
  document.getElementById('subNewRate').textContent='åŸºæº–: '+criteria.newRate+'%';
  document.getElementById('subHerbRate').textContent='åŸºæº–: '+criteria.herbRate+'%';
  document.getElementById('subOndaRate').textContent='åŸºæº–: '+criteria.ondaRate+'%';
  document.getElementById('subUnitPrice').textContent='åŸºæº–: Â¥'+(criteria.unitPrice||0).toLocaleString();
  document.getElementById('lastUpdate').textContent='æœ€çµ‚æ›´æ–°: '+new Date().toLocaleString('ja-JP');
  renderAll();
}

function fmt(n){return n?'Â¥'+n.toLocaleString():'Â¥0'}
function pct(n){return n+'%'}
function getRankClass(i){return i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'rank-other'}
function esc(s){return s.replace(/'/g,"\\'")}

function generateAdvice(s){
  var tips=[],strengths=[];
  if(s.newRate>=60)strengths.push('æ–°è¦å¥‘ç´„ç‡ãŒ<span class="highlight">'+s.newRate+'%</span>ã¨éå¸¸ã«é«˜ã„');
  else if(s.newRate>=criteria.newRate)strengths.push('æ–°è¦å¥‘ç´„ç‡ãŒåŸºæº–ã‚’ã‚¯ãƒªã‚¢');
  else if(s.newRate>0)tips.push('æ–°è¦å¥‘ç´„ç‡ãŒ<span class="improve">'+s.newRate+'%</span>ï¼ˆåŸºæº–'+criteria.newRate+'%ï¼‰ã€‚ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°æ™‚ã®ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°ãƒˆãƒ¼ã‚¯ã‚’è¦‹ç›´ã—ã¦ã¿ã¾ã—ã‚‡ã†');
  else tips.push('æ–°è¦å¥‘ç´„ãŒã¾ã å–ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…ˆè¼©ã®ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°ã‚’è¦‹å­¦ã—ã¦<span class="improve">æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³</span>ã‚’å­¦ã³ã¾ã—ã‚‡ã†');
  if(s.unitPrice>=100000)strengths.push('å¥‘ç´„å˜ä¾¡ãŒ<span class="highlight">'+fmt(s.unitPrice)+'</span>ã¨é«˜å˜ä¾¡ã‚’ç¶­æŒ');
  else if(s.unitPrice>=criteria.unitPrice)strengths.push('å¥‘ç´„å˜ä¾¡ã¯åŸºæº–ä»¥ä¸Š');
  else if(s.unitPrice>0)tips.push('å¥‘ç´„å˜ä¾¡ãŒ<span class="improve">'+fmt(s.unitPrice)+'</span>ã¨ã‚„ã‚„ä½ã‚ã€‚ä¸Šä½ã‚³ãƒ¼ã‚¹ã®é­…åŠ›ã‚’ã—ã£ã‹ã‚Šä¼ãˆã¾ã—ã‚‡ã†');
  if(s.ondaRate>=67)strengths.push('ã‚ªãƒ³ãƒ€ãƒªãƒ•ãƒˆå¥‘ç´„ç‡ãŒ<span class="highlight">'+s.ondaRate+'%</span>ã§å„ªç§€');
  else if(s.ondaRate>=criteria.ondaRate)strengths.push('ã‚ªãƒ³ãƒ€ãƒªãƒ•ãƒˆå¥‘ç´„ç‡ãŒåŸºæº–ã‚¯ãƒªã‚¢');
  else if(s.ondaCount>0&&s.ondaRate>0)tips.push('ã‚ªãƒ³ãƒ€ãƒªãƒ•ãƒˆå¥‘ç´„ç‡ã‚’ã‚‚ã†å°‘ã—ä¸Šã’ãŸã„ã¨ã“ã‚ã€‚ãƒ“ãƒ•ã‚©ãƒ¼ã‚¢ãƒ•ã‚¿ãƒ¼å†™çœŸã‚’æ´»ç”¨ã—ãŸ<span class="improve">ææ¡ˆãƒˆãƒ¼ã‚¯</span>ã‚’è©¦ã—ã¦ã¿ã¦');
  if(s.herbRate>=50)strengths.push('ãƒãƒ¼ãƒ–æ–°è¦å¥‘ç´„ç‡ãŒ<span class="highlight">'+s.herbRate+'%</span>ã§è‰¯å¥½');
  else if(s.herbRate>=criteria.herbRate)strengths.push('ãƒãƒ¼ãƒ–å¥‘ç´„ç‡ãŒåŸºæº–ã‚¯ãƒªã‚¢');
  else if(s.herbRate>0&&s.herbRate<criteria.herbRate)tips.push('ãƒãƒ¼ãƒ–ã®å¥‘ç´„ç‡ã«ä¼¸ã³ã—ã‚ã‚ã‚Šã€‚<span class="improve">ãƒãƒ¼ãƒ–ã®åŠ¹æœèª¬æ˜</span>ã‚’ä¸å¯§ã«');
  else if(s.herbRate===0&&s.herbNew>0)tips.push('ãƒãƒ¼ãƒ–æ–°è¦ã®ãƒãƒ£ãƒ³ã‚¹ã‚’æ´»ã‹ã›ã¦ã„ã¾ã›ã‚“ã€‚<span class="improve">ä½“é¨“ãƒ¡ãƒ‹ãƒ¥ãƒ¼</span>ã®ææ¡ˆã‚’æ„è­˜ã—ã¾ã—ã‚‡ã†');
  if(s.herbSales>=200000)strengths.push('ãƒãƒ¼ãƒ–å£²ä¸ŠãŒ<span class="highlight">'+fmt(s.herbSales)+'</span>ã§ç´ æ™´ã‚‰ã—ã„');
  if(s.newCount>=8)strengths.push('æ‹…å½“æ•°ãŒ<span class="highlight">'+s.newCount+'äºº</span>ã¨å¤šãé›†å®¢åŠ›ãŒé«˜ã„');
  else if(s.newCount<=2)tips.push('æ‹…å½“æ•°ãŒå°‘ãªã‚ã€‚<span class="improve">ã‚·ãƒ•ãƒˆã‚„é›†å®¢</span>é¢ã®èª¿æ•´ãŒå¿…è¦ã‹ã‚‚');
  var html='';
  if(strengths.length>0)html+='<p style="margin-bottom:8px"><strong>ğŸ’ª å¼·ã¿ï¼š</strong>'+strengths.join('ã€‚ã¾ãŸã€')+'ã€‚</p>';
  if(tips.length>0)html+='<p><strong>ğŸ¯ æ”¹å–„ãƒã‚¤ãƒ³ãƒˆï¼š</strong>'+tips.join('ã€‚ã•ã‚‰ã«ã€')+'ã€‚</p>';
  if(strengths.length>0&&tips.length===0)html+='<p style="margin-top:8px">ğŸŒŸ ç´ æ™´ã‚‰ã—ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ã“ã®èª¿å­ã§é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼</p>';
  if(strengths.length===0&&tips.length>0)html+='<p style="margin-top:8px">ğŸ’¡ ä¸€ã¤ãšã¤æ”¹å–„ã™ã‚Œã°å¤§ä¸ˆå¤«ï¼å¾—æ„ãªåˆ†é‡ã‹ã‚‰ä¼¸ã°ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚</p>';
  return html;
}

function renderAll(){
  var act=activeStaff;
  if(act.length===0){
    document.getElementById('avgNewRate').textContent='--';document.getElementById('avgHerbRate').textContent='--';
    document.getElementById('avgOndaRate').textContent='--';document.getElementById('avgUnitPrice').textContent='--';
    document.getElementById('topPerformers').innerHTML='<div class="no-data">ğŸ“­ ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    document.getElementById('needsSupport').innerHTML='<div class="no-data">ğŸ“­ ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
  }else{
    var avgNew=Math.round(act.reduce(function(a,s){return a+s.newRate},0)/act.length);
    var ha=act.filter(function(s){return s.herbNew>0});var avgHerb=ha.length?Math.round(ha.reduce(function(a,s){return a+s.herbRate},0)/ha.length):0;
    var oa=act.filter(function(s){return s.ondaCount>0});var avgOnda=oa.length?Math.round(oa.reduce(function(a,s){return a+s.ondaRate},0)/oa.length):0;
    var pr=act.filter(function(s){return s.unitPrice>0});var avgPrice=pr.length?Math.round(pr.reduce(function(a,s){return a+s.unitPrice},0)/pr.length):0;
    document.getElementById('avgNewRate').textContent=avgNew+'%';document.getElementById('avgHerbRate').textContent=avgHerb+'%';
    document.getElementById('avgOndaRate').textContent=avgOnda+'%';document.getElementById('avgUnitPrice').textContent=fmt(avgPrice);
    var t3=activeStaff.slice().sort(function(a,b){return b.newRate-a.newRate}).slice(0,3);
    document.getElementById('topPerformers').innerHTML=t3.map(function(s,i){return staffRowHTML(s,i,'top')}).join('');
    var nh=activeStaff.filter(function(s){return s.newRate<criteria.newRate&&s.newCount>=3}).sort(function(a,b){return a.newRate-b.newRate}).slice(0,3);
    document.getElementById('needsSupport').innerHTML=nh.length>0?nh.map(function(s,i){return staffRowHTML(s,i+10,'support')}).join(''):'<div style="text-align:center;padding:12px;color:var(--gray-500);font-size:13px;">åŸºæº–æœªé”ã®ã‚¹ã‚¿ãƒƒãƒ•ã¯ã„ã¾ã›ã‚“ ğŸ‰</div>';
  }
  renderRanking('rankNewRate','newRate',function(s){return pct(s.newRate)});
  renderRanking('rankUnitPrice','unitPrice',function(s){return fmt(s.unitPrice)});
  renderRanking('rankHerbSales','herbSales',function(s){return fmt(s.herbSales)});
  renderAlerts();populateSelect();
}

function staffRowHTML(s,idx,mode){
  var rc=mode==='support'?'rank-other':getRankClass(idx),ac=mode==='support'?'alert-row':'';
  return '<div class="staff-row '+ac+'" onclick="openModal(\''+esc(s.name)+'\')"><div class="rank-badge '+rc+'">'+(mode==='support'?'!':(idx+1))+'</div><div class="staff-info"><div class="staff-name">'+s.name+'</div><div class="staff-stats"><div class="staff-stat green">å¥‘ç´„ç‡ <span>'+s.newRate+'%</span></div><div class="staff-stat pink">å˜ä¾¡ <span>'+fmt(s.unitPrice)+'</span></div></div><div class="progress-bar"><div class="progress-fill '+(mode==='support'?'pink':'green')+'" style="width:'+Math.min(s.newRate,100)+'%"></div></div></div><div class="staff-arrow">â€º</div></div>';
}

function renderRanking(id,key,fmtr){
  var sorted=activeStaff.filter(function(s){return s[key]>0}).sort(function(a,b){return b[key]-a[key]}).slice(0,8);
  var max=sorted.length>0?sorted[0][key]:1;
  document.getElementById(id).innerHTML=sorted.length>0?sorted.map(function(s,i){return '<div class="comparison-item"><div class="comparison-label"><span class="comparison-name">'+(i+1)+'. '+s.name+'</span><span class="comparison-val">'+fmtr(s)+'</span></div><div class="progress-bar"><div class="progress-fill '+(i<3?'green':i<6?'blue':'pink')+'" style="width:'+(s[key]/max*100)+'%"></div></div></div>'}).join(''):'<div class="no-data">ğŸ“­ ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
}

function renderAlerts(){
  var alerts=[];
  staffData.filter(function(s){return s.newCount>0}).forEach(function(s){
    var iss=[];
    if(s.newRate>0&&s.newRate<criteria.newRate)iss.push('æ–°è¦å¥‘ç´„ç‡ '+s.newRate+'% (åŸºæº–'+criteria.newRate+'%)');
    if(s.ondaCount>0&&s.ondaRate>0&&s.ondaRate<criteria.ondaRate)iss.push('ã‚ªãƒ³ãƒ€ãƒªãƒ•ãƒˆç‡ '+s.ondaRate+'% (åŸºæº–'+criteria.ondaRate+'%)');
    if(s.herbNew>0&&s.herbRate>0&&s.herbRate<criteria.herbRate)iss.push('ãƒãƒ¼ãƒ–ç‡ '+s.herbRate+'% (åŸºæº–'+criteria.herbRate+'%)');
    if(s.newRate===0&&s.newCount>=3)iss.push('æ–°è¦å¥‘ç´„ç‡ 0%');
    if(iss.length>0)alerts.push({name:s.name,issues:iss,s:s});
  });
  document.getElementById('alertList').innerHTML=alerts.length>0?alerts.map(function(a){return '<div class="staff-row alert-row" onclick="openModal(\''+esc(a.name)+'\')"><div class="rank-badge rank-other" style="background:var(--pink-soft);color:var(--pink-text)">âš </div><div class="staff-info"><div class="staff-name">'+a.name+'</div><div style="font-size:10px;color:var(--pink-text);margin-top:3px">'+a.issues.join(' / ')+'</div></div><div class="staff-arrow">â€º</div></div>'}).join(''):'<div class="no-data">âœ… ã‚¢ãƒ©ãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div>';
}

function populateSelect(){
  var sel=document.getElementById('staffSelect'),cv=sel.value;
  sel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
  staffData.filter(function(s){return s.newCount>0}).sort(function(a,b){return a.name.localeCompare(b.name,'ja')}).forEach(function(s){var o=document.createElement('option');o.value=s.name;o.textContent=s.name;sel.appendChild(o)});
  if(cv)sel.value=cv;
}

function showIndividual(){var n=document.getElementById('staffSelect').value;if(!n){document.getElementById('individualContent').innerHTML='';return}var s=staffData.find(function(x){return x.name===n});if(s)renderDetail(s,'individualContent')}

function renderDetail(s,tid){
  var sk=[{label:'æ–°è¦å¥‘ç´„ç‡',value:s.newRate,target:criteria.newRate},{label:'ã‚ªãƒ³ãƒ€ãƒªãƒ•ãƒˆå¥‘ç´„ç‡',value:s.ondaRate,target:criteria.ondaRate},{label:'ãƒãƒ¼ãƒ–æ–°è¦å¥‘ç´„ç‡',value:s.herbRate,target:criteria.herbRate}];
  document.getElementById(tid).innerHTML='<div class="modal-stats"><div class="modal-stat g"><div class="num">'+s.newCount+'</div><div class="lbl">æ–°è¦æ‹…å½“æ•°</div></div><div class="modal-stat p"><div class="num">'+fmt(s.unitPrice)+'</div><div class="lbl">å¥‘ç´„å˜ä¾¡</div></div><div class="modal-stat b"><div class="num">'+fmt(s.herbSales)+'</div><div class="lbl">ãƒãƒ¼ãƒ–å£²ä¸Š</div></div></div><div class="section-title" style="font-size:13px;">ğŸ“Š ã‚¹ã‚­ãƒ«ãƒãƒ©ãƒ³ã‚¹</div><div class="skill-section">'+sk.map(function(k){return '<div class="skill-bar-item"><div class="skill-bar-label"><span class="name">'+k.label+'</span><span class="val" style="color:'+(k.value>=k.target?'var(--green-main)':'var(--pink-text)')+'">'+k.value+'%'+(k.value>=k.target?' âœ“':' (åŸºæº–'+k.target+'%)')+'</span></div><div class="skill-bar"><div class="skill-bar-fill" style="width:'+k.value+'%;background:'+(k.value>=k.target?'linear-gradient(90deg,var(--green-main),#4FD080)':'linear-gradient(90deg,var(--pink-accent),#FFB6C8)')+'"></div></div></div>'}).join('')+'</div><div class="ai-advice"><div class="ai-advice-header">ğŸ¤– AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ <span class="ai-badge">AI</span></div>'+generateAdvice(s)+'</div>';
}

function openModal(name){var s=staffData.find(function(x){return x.name===name});if(!s)return;document.getElementById('modalTitle').textContent='ğŸ“‹ '+s.name;renderDetail(s,'modalBody');document.getElementById('modalOverlay').classList.add('active');document.body.style.overflow='hidden'}
function closeModal(e){if(e.target===document.getElementById('modalOverlay'))closeModalDirect()}
function closeModalDirect(){document.getElementById('modalOverlay').classList.remove('active');document.body.style.overflow=''}
function switchTab(tab,btn){document.querySelectorAll('.tab-panel').forEach(function(p){p.classList.remove('active')});document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active')});document.getElementById('tab-'+tab).classList.add('active');btn.classList.add('active')}

loadData();
</script>
</body>
</html>
